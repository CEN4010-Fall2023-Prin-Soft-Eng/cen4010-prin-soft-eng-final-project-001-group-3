<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRP 3 Game Reviews</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <!-- Bootstrap JS and Popper.js (required for Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    
</head>

<body>
    <!-- Search and Filter Section -->
    <div class="top-bar">
        <div class="container mt-4">
            <div class="row">
                <div class="col-md-3">
                    <input type="text" id="titleSearch" class="form-control" placeholder="Search by Title...">
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
                <div class="col-md-3">
                    <select id="genreFilter" class="form-control">
                        <option value="">Select Genre</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="platformFilter" class="form-control">
                        <option value="">Select Platform</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="tagFilter" class="form-control">
                        <option value="">Select Tag</option>
                    </select>
                </div>
            </div>
            <nav>
                <ul class="nav nav-tab">
                    <li class="ml-auto" id="accountSection">
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <header>
        <h1 class="text-center">Game Reviewer</h1>
    </header>

    <div id="data-container">
        <!-- Data based on the desired key will be displayed here -->
    </div>

    <div id="pagination">
        <button onclick="prevPage()">Previous Page</button>
        <span id="currentPage">Page 1</span>
        <button onclick="nextPage()">Next Page</button>
    </div>

    <!-- Modal container -->
    <div id="modal-container"></div>

    <!-- Single Modal for Game Reviews -->
    <div class="modal" id="reviewModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="gameTitle">Write a Review</h4>
                    <button type="button" class="close" onclick="closeReviewModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <textarea id="reviewText" class="form-control" placeholder="Write your review"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitReview()">Submit Review</button>
                </div>
            </div>
        </div>
    </div>

    
    <script>
        let currentPage = 1;
        const itemsPerPage = 10; // Number of items to display per page
        const apiKey = '48288ff667454f7681cb863cb83b9b82';

        // Function to fetch and display games data from JSON with pagination, search, and filters
        async function fetchData(page, searchQuery = '', genre = '', platform = '', tag = '') {
            try {
                const offset = (page - 1) * itemsPerPage;
                const searchParam = searchQuery ? `&search=${encodeURIComponent(searchQuery)}` : '';
                const genreParam = genre ? `&genres=${genre}` : '';
                const platformParam = platform ? `&platforms=${platform}` : '';
                const tagParam = tag ? `&tags=${tag}` : '';

                const response = await fetch(`https://api.rawg.io/api/games?dates=2023-01-01,2023-11-01&ordering=-added&key=${apiKey}&page_size=${itemsPerPage}&page=${page}&offset=${offset}${searchParam}${genreParam}${platformParam}${tagParam}`);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const jsonData = await response.json();

                displayGamesData(jsonData);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Function to display games data from JSON on the HTML page
        function displayGamesData(data) {
    const dataContainer = document.getElementById('data-container');
    const currentPageElement = document.getElementById('currentPage');
    const modalContainer = document.getElementById('modal-container');

    if ('results' in data) {
        const gamesData = data.results;

        if (Array.isArray(gamesData) && gamesData.length > 0) {
            const gamesList = gamesData.map(game => {
                const backgroundImage = game.background_image || 'default-image-url.jpg';
                const gameId = game.id;

                const gameName = game.name.replace(/'/g, "\\'");

                        return `
                            <div class="game-container" style="background-image: url(${backgroundImage})">
                    <p>${game.name}</p>
                                <a href="game.html?gameId=${game.id}"><button class="btn btn-primary">Show all Reviews</button></a>
                    <button class="btn thumbs-up" onclick="openReviewModal(${game.id}, '${gameName}', true)"> üëç </button>
                    <button class="btn thumbs-down" onclick="openReviewModal(${game.id}, '${gameName}', false)"> üëé </button>
                            </div>
                        `;
            }).join('');

            dataContainer.innerHTML = gamesList;
            currentPageElement.textContent = `Page ${currentPage}`;
        } else {
            dataContainer.textContent = 'No games data available.';
            currentPageElement.textContent = 'Page 1';
        }
    } else {
        dataContainer.textContent = 'No "results" key found in the data.';
    }
}

        document.querySelector('.btn-primary').addEventListener('click', searchGames);

        document.querySelector('#titleSearch').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                searchGames();
            }
        });

        function searchGames() {
            const searchQuery = document.getElementById('titleSearch').value;
            const genre = document.getElementById('genreFilter').value;
            const platform = document.getElementById('platformFilter').value;
            const tag = document.getElementById('tagFilter').value;

            fetchData(1, searchQuery, genre, platform, tag);
        }

        // Function to go to the previous page
        function prevPage() {
            if (currentPage > 1) {
                currentPage -= 1;
                fetchData(currentPage);
            }
        }

        // Function to go to the next page
        function nextPage() {
            currentPage += 1;
            fetchData(currentPage);
        }

        async function fetchRawgData(endpoint) {
            try {
                const response = await fetch(`https://api.rawg.io/api/${endpoint}?key=${apiKey}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        async function populateFilters() {
            const genresData = await fetchRawgData('genres');
            const platformsData = await fetchRawgData('platforms');
            const tagsData = await fetchRawgData('tags');

            populateSelect('genreFilter', genresData.results);
            populateSelect('platformFilter', platformsData.results);
            populateSelect('tagFilter', tagsData.results);
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.id;
                opt.textContent = option.name;
                select.appendChild(opt);
            });
        }

        let selectedGameId;
        let selectedGameName;

        function openReviewModal(gameId, gameName, thumbsup) {
            let emoji = thumbsup ? 'üëç' : 'üëé';

            selectedGameId = gameId;
            selectedGameName = gameName;

            document.getElementById('gameTitle').textContent = `${emoji} Write a Review for ${gameName}`;
            $('#reviewModal').modal('show');
        }

        function closeReviewModal() {
            $('#reviewModal').modal('hide');
        }

        async function submitReview() {
            const reviewText = document.getElementById('reviewText').value;
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/review/${selectedGameId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({ reviewText })
                });

                const result = await response.json();

                if (response.status === 201) {
                    alert('Review added successfully');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error while submitting review: ' + error);
            }

            closeReviewModal();
        }


        async function updateAccountSection() {
            const accountSection = document.getElementById('accountSection');
            const token = localStorage.getItem('token');

            if (token !== null) {
                const response = await fetch('/profile-data', {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                });

                const profilePicture = (await response.json()).profilePicture;

                accountSection.innerHTML = `
                <div style="display: flex;">
                    <img src="${profilePicture}" alt="Profile Picture" style="width: 40px; height: 40px; border-radius: 50%;">
                    <div style="display: flex; flex-direction: column; align-items: flex-end;">
                        <a class="nav-link" href="profile.html" style="text-align: right;">My Profile</a>
                        <a class="nav-link" href="#" onclick="logout()" style="text-align: right;">Logout</a>
                    </div>
                </div>
            `;
            } else {
                accountSection.innerHTML = `
            <a class="nav-link" href="Signin.html">Sign in</a>
            <a class="nav-link" href="CreateAccount.html">Create Account</a>
        `;
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.reload();
        }


        window.onload = () => {
            fetchData(currentPage);
            populateFilters();
            updateAccountSection();
        };
    </script>

    <footer>
        <p>&copy; 2023 GROUP 3 FINAL PROJECT</p>
    </footer>

</body>

</html>