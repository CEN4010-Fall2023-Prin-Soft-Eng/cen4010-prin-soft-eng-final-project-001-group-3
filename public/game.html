<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <title>Game Details</title>
    <link rel="stylesheet" href="game.css">
</head>

<body>
    <header class="mb-4">
        <h1 class="text-center"><a href="homepage.html">Back to Home</a></h1>
    </header>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-6">
                <h2>Game Details</h2>
                <p><strong>Title:</strong> <span id="gameTitle"></span></p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-lg-12">
                <h3 class="review-title">Reviews</h3>
                <ul id="reviewsList" class="list-group">
                </ul>
            </div>
        </div>
    </div>


    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('gameId');
        const token = localStorage.getItem('token');

        async function upvoteReview(reviewId) {
            const response = await fetch(`/upvote/${gameId}/${reviewId}`, {
                method: 'POST',
                headers: {
                    'Authorization': token
                }
            });

            const jsonData = await response.json();

            if (jsonData.message === "Upvote successful") {
                const upvoteButton = document.getElementById(`upvote${reviewId}`);
                const downvoteButton = document.getElementById(`downvote${reviewId}`);

                upvoteButton.innerHTML = `👍 ${jsonData.positiveVotes}`;
                downvoteButton.innerHTML = `👎 ${jsonData.negativeVotes}`;
            }

            alert(jsonData.message);
        }

        async function downvoteReview(reviewId) {
            const response = await fetch(`/downvote/${gameId}/${reviewId}`, {
                method: 'POST',
                headers: {
                    'Authorization': token
                }
            });

            const jsonData = await response.json();

            if (jsonData.message === "Downvote successful") {
                const upvoteButton = document.getElementById(`upvote${reviewId}`);
                const downvoteButton = document.getElementById(`downvote${reviewId}`);

                upvoteButton.innerHTML = `👍 ${jsonData.positiveVotes}`;
                downvoteButton.innerHTML = `👎 ${jsonData.negativeVotes}`;
            }

            alert(jsonData.message);
        }

        document.addEventListener("DOMContentLoaded", async function () {
            const response = await fetch(`/game/${gameId}`, {
                method: 'GET',
                headers: {
                    'Authorization': token
                }
            });

            const jsonData = await response.json();

            const gameTitleElement = document.getElementById("gameTitle");
            gameTitleElement.textContent = jsonData.title;

            const reviewsList = document.getElementById("reviewsList");

            let counter = 0;

            jsonData.reviews.forEach((review) => {
                const li = document.createElement("li");
                li.classList.add("list-group-item");
                li.innerHTML = `
                <img src="${review.profilePicture}" alt="Profile Picture" style="width: 40px; height: 40px; border-radius: 50%;">
                <strong><a href="profile.html?username=${review.username}">${review.username}</strong></a>: ${review.text}
                <button id="upvote${counter}" class="btn thumbs-up" onclick="upvoteReview(${counter})"> 👍 ${review.positiveVotes} </button>
                <button id="downvote${counter}" class="btn thumbs-down" onclick="downvoteReview(${counter})"> 👎 ${review.negativeVotes} </button>
            `;
                counter++;
                reviewsList.appendChild(li);
            });
        });
    </script>
</body>

</html>