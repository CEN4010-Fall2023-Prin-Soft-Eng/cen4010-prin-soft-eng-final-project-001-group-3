<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <title>Game Details</title>
    <link rel="stylesheet" href="game.css">
</head>

<body>
    <div class="Homelink">
        <header><a href="homepage.html" >
            <img src="gameReviewerLogo.png" style="vertical-align: middle; margin-bottom: 43px; margin-left: 15px;">
            Game Reviewer
        </a></header>
        </div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-6">
                <h2>Game Details</h2>
                <p><strong>Title:</strong> <span id="gameTitle"></span></p>
                <p>üëç <span id="positiveVotesCounter"></span></p>
                <p>üëé <span id="negativeVotesCounter"></span></p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-lg-12">
                <h3 class="review-title">Reviews</h3>
                <ul id="reviewsList" class="list-group">
                </ul>
            </div>
        </div>
    </div>


    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const gameId = urlParams.get('gameId');
        const token = localStorage.getItem('token');
        const currentUser = localStorage.getItem('currentUser');

        async function upvoteReview(reviewId) {
            const response = await fetch(`/upvote/${gameId}/${reviewId}`, {
                method: 'POST',
                headers: {
                    'Authorization': token
                }
            });

            const jsonData = await response.json();

            if (jsonData.message === "Upvote successful") {
                const upvoteButton = document.getElementById(`upvote${reviewId}`);
                const downvoteButton = document.getElementById(`downvote${reviewId}`);

                upvoteButton.innerHTML = `üëç ${jsonData.positiveVotes}`;
                downvoteButton.innerHTML = `üëé ${jsonData.negativeVotes}`;
            }

            alert(jsonData.message);
        }

        async function downvoteReview(reviewId) {
            const response = await fetch(`/downvote/${gameId}/${reviewId}`, {
                method: 'POST',
                headers: {
                    'Authorization': token
                }
            });

            const jsonData = await response.json();

            if (jsonData.message === "Downvote successful") {
                const upvoteButton = document.getElementById(`upvote${reviewId}`);
                const downvoteButton = document.getElementById(`downvote${reviewId}`);

                upvoteButton.innerHTML = `üëç ${jsonData.positiveVotes}`;
                downvoteButton.innerHTML = `üëé ${jsonData.negativeVotes}`;
            }

            alert(jsonData.message);
        }

        function editReview(index) {
            const reviewTextElement = document.getElementById(`reviewText${index}`);
            const originalText = reviewTextElement.innerText;

            reviewTextElement.innerHTML = `
                <input type="text" id="editInput${index}" value="${originalText}">
                <button class="btn btn-success" onclick="saveEditedReview(${index})">Save</button>
            `;
        }

        async function saveEditedReview(index) {
            const editedText = document.getElementById(`editInput${index}`).value;

            const response = await fetch(`/review/${gameId}`, {
                method: 'PUT',
                body: JSON.stringify({ reviewText: editedText }),
                headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                },
            });

            document.getElementById(`reviewText${index}`).innerText = editedText;
        }

        async function deleteReview(index) {
            if (!confirm("Are you sure you want to delete this review?")) {
                return;
            }

            const response = await fetch(`/review/${gameId}`, {
                method: 'DELETE',
                body: JSON.stringify({ reviewId: index }),
                headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                },
            });

            const reviewElement = document.getElementById(`reviewItem${index}`);
            if (reviewElement) {
                reviewElement.remove();
            }
        }


        document.addEventListener("DOMContentLoaded", async function () {
            const response = await fetch(`/game/${gameId}`, {
                method: 'GET',
                headers: {
                    'Authorization': token
                }
            });

            const jsonData = await response.json();

            const gameTitleElement = document.getElementById("gameTitle");
            gameTitleElement.textContent = jsonData.title;

            const reviewsList = document.getElementById("reviewsList");

            let counter = 0;
            let positiveVotes = 0;
            let negativeVotes = 0;

            jsonData.reviews.forEach((review) => {
                const li = document.createElement("li");
                li.id = `reviewItem${counter}`;
                li.classList.add("list-group-item");

                let editButtonHTML = '';
                let deleteButtonHTML = '';
                if (review.username === currentUser) {
                    editButtonHTML = `<button id="edit${counter}" class="btn btn-secondary" onclick="editReview(${counter})">Edit</button>`;
                    deleteButtonHTML = `<button id="delete${counter}" class="btn btn-danger" onclick="deleteReview(${counter})">Delete</button>`;
                }

                let emoji = review.positive ? "üëç" : "üëé";

                if (review.positive) {
                    positiveVotes += 1;
                } else {
                    negativeVotes += 1;
                }

                li.innerHTML = `
                    <img src="${review.profilePicture}" alt="Profile Picture" style="width: 40px; height: 40px; border-radius: 50%;">
                    <strong><a href="profile.html?username=${review.username}">${review.username} ${emoji}</strong></a>: <span id="reviewText${counter}">${review.text}</span>
                    <button id="upvote${counter}" class="btn positive-icon" onclick="upvoteReview(${counter})"> üîº ${review.positiveVotes} </button>
                    <button id="downvote${counter}" class="btn negative-icon" onclick="downvoteReview(${counter})"> üîΩ ${review.negativeVotes} </button>
                    ${editButtonHTML}
                    ${deleteButtonHTML}
                `;
                counter++;
                reviewsList.appendChild(li);
            });

            const positiveVotesCounter = document.getElementById("positiveVotesCounter");
            const negativeVotesCounter = document.getElementById("negativeVotesCounter");

            positiveVotesCounter.textContent = positiveVotes;
            negativeVotesCounter.textContent = negativeVotes;
        });
    </script>
</body>

</html>